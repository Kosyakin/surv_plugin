<h2><%= @query.new_record? ? l(:label_spent_time) : @query.name %></h2>
<%= @query.persisted? && @query.description.present? ? content_tag('p', @query.description, class: 'subtitle') : '' %>

<% if @query.valid? %>
<%= javascript_include_tag '/themes/SURV/javascripts/vendor/echarts/echarts.min.js' %>

<%
  # Получаем данные из контроллера
  calendar_data = @calendar_chart_data || {}
  daily_data = calendar_data[:daily_data] || []
  date_range = calendar_data[:date_range] || []
  
  # Определяем диапазон дат
  if date_range.is_a?(Array) && date_range.length == 2
    min_date = date_range[0]
    max_date = date_range[1]
  else
    # Fallback на текущий месяц
    min_date = Date.today.beginning_of_month
    max_date = Date.today.end_of_month
  end
%>

<%= javascript_tag do %>
  // This example requires ECharts v5.4.0 or later
  const cellSize = [50, 50];
  const pieRadius = 18;

  // Функция для конвертации десятичных часов в формат Чч ММмин
  function formatHoursMinutes(decimalHours) {
    if (!decimalHours || decimalHours <= 0) return '0мин';
    var hours = Math.floor(decimalHours);
    var minutes = Math.round((decimalHours - hours) * 60);
    if (minutes === 60) { hours += 1; minutes = 0; }
    if (hours > 0 && minutes > 0) {
      return hours + 'ч ' + minutes + 'мин';
    } else if (hours > 0) {
      return hours + 'ч';
    } else {
      return minutes + 'мин';
    }
  }
  // Функция для округления до 10 минут (0.1667 часа)
  function roundTo10Minutes(hours) {
    if (hours <= 0) return 0;
    var minutes = hours * 60;
    var roundedMinutes = Math.round(minutes / 10) * 10;
    return roundedMinutes / 60;
  }
  
  // Функция для получения цвета из CSS классов
  function getColorFromCSS(className) {
    // Создаем временный элемент для получения цвета из CSS
    var tempEl = document.createElement('div');
    tempEl.className = className;
    tempEl.style.display = 'none';
    document.body.appendChild(tempEl);
    
    // Получаем вычисленные стили
    var computedStyle = window.getComputedStyle(tempEl);
    var color = computedStyle.backgroundColor;
    
    // Удаляем временный элемент
    document.body.removeChild(tempEl);
    
    return color || 'rgba(0, 0, 0, 0.7)'; // fallback цвет
  }

  // Данные из контроллера
  var dailyData = <%= raw(daily_data.to_json) %>;
  // Округляем deficit в dailyData до 10 минут
  dailyData = dailyData.map(function(item) {
    if (item.length > 3 && item[3] > 0) { // item[3] - deficit
      var newItem = item.slice();
      newItem[3] = Math.round(roundTo10Minutes(newItem[3]) * 100) / 100;
      return newItem;
    }
    return item;
  });
  // Определяем диапазон дат для календаря
  var dateFrom = '<%= min_date.strftime('%Y-%m-%d') %>';
  var dateTo = '<%= max_date.strftime('%Y-%m-%d') %>';
  
  // Создаем scatter data для отображения дней на календаре
  // item[0]=date, item[1]=approved, item[2]=unapproved, item[3]=deficit
  // Для scatter используем общее количество часов (approved + unapproved) для размера маркера
  var scatterData = dailyData.map(function(item) {
    return [item[0], item[1] + item[2]]; // date, total_hours
  });

  // Создаем pie series для каждого дня
  // item[0]=date, item[1]=approved, item[2]=unapproved, item[3]=deficit, item[4]=is_empty
  var pieSeries = dailyData.map(function (item, index) {
    var is_empty = item[4] || false;
    
    // Получаем цвета из CSS
    var approvedColor = getColorFromCSS('chart-approved');
    var unapprovedColor = getColorFromCSS('chart-unapproved');
    var deficitColor = getColorFromCSS('chart-deficit');
    var emptyDayColor = getColorFromCSS('chart-empty-day');
    
    return {
      type: 'pie',
      id: 'pie-' + index,
      center: item[0],
      radius: pieRadius,
      coordinateSystem: 'calendar',
      label: {
        show: false
      },
      emphasis: {
        label: {
          show: false
        },
        scale: true,
        scaleSize: 1.2
      },
      data: is_empty ? [
        { 
          name: 'Пустой день', 
          value: item[3] || 8.67, // deficit или план на день
          itemStyle: { color: emptyDayColor }
        }
      ] : [
        { 
          name: 'Согласовано', 
          value: item[1], // approved hours
          itemStyle: { color: approvedColor }
        },
        { 
          name: 'Требуется согласование', 
          value: item[2], // unapproved hours
          itemStyle: { color: unapprovedColor }
        },
        { 
          name: 'Осталось распределить', 
          value: item[3], // deficit
          itemStyle: { color: deficitColor }
        }
      ]
    };
  });
  
  // Дата диапазон для календаря
  var calendarDateRange = [dateFrom, dateTo];
  
  var calendarOption = {
  tooltip: {
    formatter: function (params) {
      if (params.seriesType === 'pie') {
        // Показываем категорию и значение
        return `${params.data.name}: ${formatHoursMinutes(params.data.value)}`;
      }
      return echarts.time.format(params.value[0], '{yyyy}-{MM}-{dd}', false);
    }
  },
  legend: {
    data: ['Согласовано', 'Требуется согласование', 'Осталось распределить'],
    bottom: 10
  },
  calendar: {
    top: 60,
    left: 30,
    bottom: 50,
    right: 40,
    orient: 'vertical',
    cellSize: cellSize,
    yearLabel: {
      show: true,
      fontSize: 14
    },
    dayLabel: {
      margin: 10,
      firstDay: 1,
      nameMap: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
    },
    monthLabel: {
      show: true,
      nameMap: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
      fontSize: 12,
      color: '#000'
    },
    range: calendarDateRange
  },
  series: [
    {
      id: 'label',
      type: 'scatter',
      coordinateSystem: 'calendar',
      symbolSize: 0,
      label: {
        show: true,
        formatter: function (params) {
          return echarts.time.format(params.value[0], '{dd}', false);
        },
        offset: [-cellSize[0] / 2 + 5, -cellSize[1] / 2 + 5],
        // ИЗМЕНЕНИЕ СТИЛЯ ГРАФИКА: размер и цвет цифр дней месяца
        fontSize: 16, // Увеличен размер шрифта с 10 до 16
        color: '#000000', // Черный цвет для цифр
        fontWeight: 'bold' // Жирный шрифт для лучшей читаемости
      },
      // ИЗМЕНЕНИЕ СТИЛЯ ГРАФИКА: убираем обводку вокруг маркеров
      itemStyle: {
        borderWidth: 0, // Убираем обводку (синяя обводка была здесь)
        borderColor: 'transparent' // Прозрачный цвет обводки
      },
      data: scatterData
    },
    ...pieSeries
  ]
};

  // Вычисляем статистику
  function calculateStats() {
    var stats = {
      approved: 0,
      unapproved: 0,
      deficit: 0
    };
    
    dailyData.forEach(function(item) {
      if (item[4] && item[4] === true) {
        // Пустой день - весь план идет в deficit
        stats.deficit += item[3] || 0;
      } else {
        stats.approved += item[1] || 0;
        stats.unapproved += item[2] || 0;
        stats.deficit += item[3] || 0;
      }
    });
    
    return {
      approved: Math.round(stats.approved * 100) / 100,
      unapproved: Math.round(stats.unapproved * 100) / 100,
      deficit: Math.round(roundTo10Minutes(stats.deficit) * 100) / 100
    };
  }
  
  // Отображаем статистику
  function displayStats(stats) {
    // Получаем цвета из CSS для статистики
    var approvedColor = getColorFromCSS('chart-approved');
    var unapprovedColor = getColorFromCSS('chart-unapproved');
    var deficitColor = getColorFromCSS('chart-deficit');
    
    var statsHtml = '<div class="surv-stats-container">' +
      '<div class="surv-stat-item">' +
        '<div class="surv-stat-label" style="color: ' + approvedColor + ';">Согласовано:</div>' +
        '<div class="surv-stat-value">' + formatHoursMinutes(stats.approved) + '</div>' +
      '</div>' +
      '<div class="surv-stat-item">' +
        '<div class="surv-stat-label" style="color: ' + unapprovedColor + ';">Требует согласования:</div>' +
        '<div class="surv-stat-value">' + formatHoursMinutes(stats.unapproved) + '</div>' +
      '</div>' +
      '<div class="surv-stat-item">' +
        '<div class="surv-stat-label" style="color: ' + deficitColor + ';">Осталось распределить:</div>' +
        '<div class="surv-stat-value">' + formatHoursMinutes(stats.deficit) + '</div>' +
      '</div>' +
    '</div>';
    
    document.getElementById('timelog-stats').innerHTML = statsHtml;
  }
  
  // Инициализация графика
  document.addEventListener('DOMContentLoaded', function() {
    var chartEl = document.getElementById('timelog-calendar-chart');
    if (chartEl) {
      var chart = echarts.init(chartEl);
      chart.setOption(calendarOption);
      window.addEventListener('resize', function(){ chart.resize(); });
      
      // Отображаем статистику
      var stats = calculateStats();
      displayStats(stats);
    }
  });
<% end %>

<div class="surv-main-container">
  <div class="surv-filters-left">
    <%= form_tag(_time_entries_path(@project, nil), :method => :get, :id => 'query_form') do %>
      <%= render :partial => 'date_range' %>
    <% end %>
  </div>
  
  <div class="surv-table-container">
    <% if @entries.empty? %>
      <p class="nodata"><%= l(:label_no_data) %></p>
    <% else %>
      <%= render_query_totals(@query) %>
      <%= render :partial => 'list', :locals => { :entries => @entries }%>
      <span class="pagination"><%= pagination_links_full @entry_pages, @entry_count %></span>

      <% other_formats_links do |f| %>
        <%= f.link_to_with_query_parameters 'CSV', {}, :onclick => "showModal('csv-export-options', '330px'); return false;" %>
        <%= f.link_to_with_query_parameters 'Atom', :key => User.current.atom_key %>
      <% end %>

      <div id="csv-export-options" style="display:none;">
        <h3 class="title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
        <%= form_tag(_time_entries_path(@project, nil, :format => 'csv'), :method => :get, :id => 'csv-export-form') do %>
        <%= query_as_hidden_field_tags @query %>
        <%= hidden_field_tag('query_name', @query.name) %>
        <p>
          <label><%= radio_button_tag 'c[]', '', true %> <%= l(:description_selected_columns) %></label><br />
          <label><%= radio_button_tag 'c[]', 'all_inline' %> <%= l(:description_all_columns) %></label>
        </p>
        <% if @query.available_block_columns.any? %>
          <fieldset id="csv-export-block-columns">
            <legend>
              <%= toggle_checkboxes_link('#csv-export-block-columns input[type=checkbox]') %>
            </legend>
            <% @query.available_block_columns.each do |column| %>
              <label><%= check_box_tag 'c[]', column.name, @query.has_column?(:column), :id => nil %> <%= column.caption %></label>
            <% end %>
          </fieldset>
        <% end %>
        <%= export_csv_encoding_select_tag %>
        <%= export_csv_separator_select_tag %>
        <p class="buttons">
          <%= submit_tag l(:button_export), :name => nil, :onclick => "hideModal(this);", :data => { :disable_with => false } %>
          <%= link_to_function l(:button_cancel), "hideModal(this);" %>
        </p>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <div class="surv-chart-right-timelog">
    <div id="timelog-calendar-chart" style="width: 100%; height: 800px;"></div>
    <div id="timelog-stats"></div>
  </div>
</div>
<% else %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% end %>

<% content_for :sidebar do %>
  <%= render :partial => 'timelog/sidebar' %>
<% end %>

<% html_title(@query.new_record? ? l(:label_spent_time) : @query.name, l(:label_details)) %>

<% content_for :header_tags do %>
    <%= auto_discovery_link_tag(:atom, {:issue_id => @issue, :format => 'atom', :key => User.current.atom_key}, :title => l(:label_spent_time)) %>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('timelog');
      });
    </script>
<% end %>