# Helper модуль для плагина статистики СУРВ
# Обеспечивает корректную фильтрацию трудозатрат в зависимости от прав пользователя
module SurvStatisticsHelper
  
  # Основной метод для получения отфильтрованного scope трудозатрат
  # Используется в представлениях для сбора статистики с учетом прав доступа
  # 
  # Фильтрация основана на праве согласования чужих трудозатрат:
  # - Если пользователь может согласовывать чужие записи - видит все
  # - Если не может согласовывать - видит только свои записи
  # 
  # @param options [Hash] опции для запроса (сортировка, лимиты и т.д.)
  # @return [ActiveRecord::Relation] отфильтрованный scope трудозатрат
  def time_entry_scope_with_visibility(options = {})
    # Получаем базовый scope из запроса (уже содержит фильтры по датам, активностям и т.д.)
    scope = @query.results_scope(options)
    
    # Применяем дополнительную фильтрацию по правам пользователя
    if should_restrict_to_own_entries?
      # Если пользователь не может согласовывать чужие записи, показываем только его записи
      scope = scope.where(user_id: User.current.id)
    end
    
    scope
  end

  private

  # Проверяет, нужно ли ограничить видимость трудозатрат только собственными записями
  # 
  # Логика работы:
  # 1. Для проектов с подпроектами - всегда показываем полную статистику (родительский уровень)
  # 2. Для проектов без подпроектов - проверяем право согласования чужих трудозатрат:
  #    - Если может согласовывать чужие записи (approve_time_entries = true) - видит ВСЕ
  #    - Если НЕ может согласовывать чужие записи (approve_time_entries = false) - видит ТОЛЬКО СВОИ
  # 
  # Это обеспечивает корректное отображение статистики на разных уровнях иерархии проектов
  # и соответствует бизнес-логике: кто может согласовывать, тот может видеть все данные
  # 
  # @return [Boolean] true если нужно ограничить видимость только своими записями
  def should_restrict_to_own_entries?
    # Проверяем наличие проекта
    return false unless @project
    
    # КРИТИЧЕСКИ ВАЖНО: Для проектов с подпроектами НЕ применяем фильтрацию
    # Это позволяет видеть полную статистику по всем подпроектам на родительском уровне
    # Без этого ограничения статистика по подпроектам была бы неполной
    return false if @project.children.visible.any?
    
    # Для проектов без подпроектов проверяем право согласования чужих трудозатрат
    # Если пользователь НЕ может согласовывать чужие записи, 
    # то он видит только свои трудозатраты
    !User.current.allowed_to?(:approve_time_entries, @project)
  end
end
