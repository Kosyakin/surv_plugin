<style>
td.buttons a.icon-edit,
td.buttons a.icon-del {
    display: none !important;
}

</style>
<h2>Согласование трудозатрат</h2>

<% if @query.valid? %>
<% if @entries.empty? %>
<p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
<%= render_query_totals(@query) %>

<div class="surv-approvals-container">
  <div class="surv-approvals-list">
    <%= render :partial => 'timelog/list', :locals => { :entries => @entries }%>
    <span class="pagination"><%= pagination_links_full @entry_pages, @entry_count %></span>
  </div>

  <div class="surv-approvals-charts">
    <!-- Большой верхний блок для выбранного графика -->
    <div class="surv-approvals-featured" id="survFeatured">
      <h3 class="surv-approvals-user-title" id="survFeaturedTitle"></h3>
      <div id="survFeaturedChart" class="surv-approvals-featured-chart" style="height: 390px;"></div>
    </div>
    <!-- Итоги по дням на каждого сотрудника -->
    <% if @user_daily_stats.present? %>
      <div class="surv-approvals-charts-grid">
        <% @user_daily_stats.each_with_index do |user_chart, index| %>
          <div class="surv-approvals-chart-container">
            <h3 class="surv-approvals-user-title"><%= user_chart[:user_name] %></h3>
            <div id="userChart<%= index %>" class="surv-approvals-user-chart"></div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="nodata">Нет данных для отображения графиков</p>
    <% end %>
  </div>

</div>

<% other_formats_links do |f| %>
  <%= f.link_to_with_query_parameters 'CSV', {}, :onclick => "showModal('csv-export-options', '330px'); return false;" %>
  <%= f.link_to_with_query_parameters 'Atom', :key => User.current.atom_key %>
<% end %>

<div id="csv-export-options" class="surv-csv-export-modal">
  <h3 class="surv-csv-export-title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
  <%= form_tag(time_entries_approval_path(:format => 'csv'), :method => :get, :id => 'csv-export-form', :class => 'surv-csv-export-form') do %>
  <%= query_as_hidden_field_tags @query %>
  <%= hidden_field_tag('query_name', @query.name) %>
  <p>
    <label><%= radio_button_tag 'c[]', '', true %> <%= l(:description_selected_columns) %></label><br />
    <label><%= radio_button_tag 'c[]', 'all_inline' %> <%= l(:description_all_columns) %></label>
  </p>
  <% if @query.available_block_columns.any? %>
    <fieldset id="csv-export-block-columns" class="surv-csv-export-fieldset">
      <legend class="surv-csv-export-legend">
        <%= toggle_checkboxes_link('#csv-export-block-columns input[type=checkbox]') %>
      </legend>
      <% @query.available_block_columns.each do |column| %>
        <label><%= check_box_tag 'c[]', column.name, @query.has_column?(:column), :id => nil %> <%= column.caption %></label>
      <% end %>
    </fieldset>
  <% end %>
  <%= export_csv_encoding_select_tag %>
  <%= export_csv_separator_select_tag %>
  <p class="surv-csv-export-buttons">
    <%= submit_tag l(:button_export), :name => nil, :onclick => "hideModal(this);", :data => { :disable_with => false }, :class => 'surv-csv-export-button' %>
    <%= link_to_function l(:button_cancel), "hideModal(this);", :class => 'surv-csv-export-button' %>
  </p>
  <% end %>
</div>
<% end %>
<% end %>

<% content_for :sidebar do %>
  <%= render :partial => 'timelog/sidebar' %>
<% end %>

<% html_title(@query.new_record? ? l(:label_spent_time) : @query.name, l(:label_details)) %>

<% content_for :header_tags do %>
    <%= auto_discovery_link_tag(:atom, {:issue_id => @issue, :format => 'atom', :key => User.current.atom_key}, :title => l(:label_spent_time)) %>
    <script src="/themes/SURV/javascripts/vendor/echarts/echarts.min.js"></script>
    
<% end %>

<% unless @entries.empty? || (@user_daily_stats.nil? || @user_daily_stats.empty?) %>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
  var userDailyStats = <%= raw (@user_daily_stats || []).to_json %>;
  var charts = [];
  var gridEl = null;
  var featuredEl = null;
  var featuredTitleEl = null;
  var featuredChart = null;
  var hiddenContainerEl = null;
  // Управление группами в левой таблице
  function applyGroupVisibility(selectedName) {
    try {
      var groupRows = document.querySelectorAll('.surv-approvals-list tr.group');
      groupRows.forEach(function(row) {
        var nameEl = row.querySelector('.name .user') || row.querySelector('.name');
        var titleText = nameEl ? (nameEl.textContent || nameEl.innerText || '').trim() : '';
        var expander = row.querySelector('.expander');
        var shouldOpen = selectedName && titleText === selectedName;
        var isOpen = row.classList.contains('open');
        if (shouldOpen && !isOpen && typeof toggleRowGroup === 'function' && expander) {
          toggleRowGroup(expander);
        } else if (!shouldOpen && isOpen && typeof toggleRowGroup === 'function' && expander) {
          toggleRowGroup(expander);
        }
      });
    } catch(e) { /* no-op */ }
  }
  
  // Получаем цвет из CSS-класса
  function getColorFromCSS(className) {
    var el = document.createElement('div');
    el.className = className;
    el.style.display = 'none';
    document.body.appendChild(el);
    var color = window.getComputedStyle(el).backgroundColor;
    document.body.removeChild(el);
    return color;
  }
  
  // Convert decimal hours to string like "5ч 10мин"
  function formatHoursMinutes(decimalHours) {
    if (!decimalHours || decimalHours <= 0) return '0мин';
    var hours = Math.floor(decimalHours);
    var minutes = Math.round((decimalHours - hours) * 60);
    if (minutes === 60) { hours += 1; minutes = 0; }
    if (hours > 0 && minutes > 0) {
      return hours + 'ч ' + minutes + 'мин';
    } else if (hours > 0) {
      return hours + 'ч';
    } else {
      return minutes + 'мин';
    }
  }

  // Столбчатые графики по дням для каждого сотрудника
  if (userDailyStats && userDailyStats.length) {
    gridEl = document.querySelector('.surv-approvals-charts-grid');
    featuredEl = document.getElementById('survFeatured');
    featuredTitleEl = document.getElementById('survFeaturedTitle');
    var featuredChartDom = document.getElementById('survFeaturedChart');
    // Явно скрываем featured-блок при загрузке страницы (без анимационных классов)
    if (featuredEl) {
      featuredEl.style.display = 'none';
    }
    // По умолчанию свернуть все группы (будет раскрыта выбранная при восстановлении/клике)
    applyGroupVisibility(null);

    function ensureFeaturedChart() {
      if (!featuredEl || !featuredChartDom) return null;
      // Гарантируем, что блок видим перед init/resize (без анимации)
      if (window.getComputedStyle(featuredEl).display === 'none') {
        featuredEl.style.display = 'block';
      }
      // Инициализируем при первом обращении
      if (!featuredChart) {
        featuredChart = echarts.init(featuredChartDom);
      }
      return featuredChart;
    }

    function renderFeatured(userChart) {
      var chart = ensureFeaturedChart();
      if (!chart || !userChart) return;
      if (featuredTitleEl) {
        featuredTitleEl.textContent = userChart.user_name || '';
      }
      var names = userChart.dates;
      var approved = userChart.chart_data.map(function(row) { return row.approved; });
      var unapproved = userChart.chart_data.map(function(row) { return row.unapproved; });
      var deficit = userChart.chart_data.map(function(row) { return row.deficit; });

      var option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function(params) {
            var title = (params[0] && params[0].axisValue) ? params[0].axisValue : '';
            var lines = params.map(function(p) {
              return p.marker + ' ' + p.seriesName + ': ' + formatHoursMinutes(p.value);
            });
            return '<strong>' + title + '</strong><br/>' + lines.join('<br/>');
          }
        },
        legend: { data: ['Согласовано', 'Требуется согласование', 'Нужно занести'] },
        grid: { top: '4%', left: '3%', right: '3%', bottom: '8%', containLabel: true },
        xAxis: { type: 'category', data: names, axisLabel: { interval: 0, rotate: 20 } },
        yAxis: { type: 'value', axisLabel: { formatter: function(v){ return formatHoursMinutes(v); } } },
        series: [
          { name: 'Согласовано', type: 'bar', stack: 'total', data: approved, itemStyle: { color: getColorFromCSS('chart-approved') } },
          { name: 'Требуется согласование', type: 'bar', stack: 'total', data: unapproved, itemStyle: { color: getColorFromCSS('chart-unapproved') } },
          { name: 'Нужно занести', type: 'bar', stack: 'total', data: deficit, itemStyle: { color: getColorFromCSS('chart-deficit') } }
        ]
      };
      chart.setOption(option, true);
      // После того как блок стал видимым — обязательно ресайз
      setTimeout(function(){
        try { chart.resize(); } catch(e) {}
      }, 0);
    }

    userDailyStats.forEach(function(userChart, index) {
      var chartDom = document.getElementById('userChart' + index);
      if (!chartDom) { return; }

      var chart = echarts.init(chartDom);
      charts.push(chart);

      var names = userChart.dates;
      var approved = userChart.chart_data.map(function(row) { return row.approved; });
      var unapproved = userChart.chart_data.map(function(row) { return row.unapproved; });
      var deficit = userChart.chart_data.map(function(row) { return row.deficit; });

      var option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function(params) {
            var title = (params[0] && params[0].axisValue) ? params[0].axisValue : '';
            var lines = params.map(function(p) {
              return p.marker + ' ' + p.seriesName + ': ' + formatHoursMinutes(p.value);
            });
            return '<strong>' + title + '</strong><br/>' + lines.join('<br/>');
          }
        },
        legend: { data: ['Согласовано', 'Требуется согласование', 'Нужно занести'] },
        grid: { top: '4%', left: '3%', right: '3%', bottom: '15%', containLabel: true },
        xAxis: { type: 'category', data: names, axisLabel: { interval: 0, rotate: 20 } },
        yAxis: { type: 'value', axisLabel: { formatter: function(v){ return formatHoursMinutes(v); } } },
        series: [
          { name: 'Согласовано', type: 'bar', stack: 'total', data: approved, itemStyle: { color: getColorFromCSS('chart-approved') } },
          { name: 'Требуется согласование', type: 'bar', stack: 'total', data: unapproved, itemStyle: { color: getColorFromCSS('chart-unapproved') } },
          { name: 'Нужно занести', type: 'bar', stack: 'total', data: deficit, itemStyle: { color: getColorFromCSS('chart-deficit') } }
        ]
      };

      chart.setOption(option);

      // Навешиваем обработчики клика: скрываем плитку внизу, рендерим дубликат вверху
      var containerEl = chartDom.closest('.surv-approvals-chart-container');
      if (containerEl) {
        // Клик по контейнеру (заголовок/пустое место)
        containerEl.addEventListener('click', function(ev) {
          // Показать крупный блок и отрисовать график
          renderFeatured(userChart);
          // Запоминаем выбранного пользователя
          try { sessionStorage.setItem('survFeaturedUserName', userChart.user_name || ''); } catch(e) {}
          // Применяем видимость групп (раскрыть выбранную, остальные скрыть)
          applyGroupVisibility(userChart.user_name || null);
          // Вернуть предыдущую скрытую плитку, если выбрали новую
          if (hiddenContainerEl && hiddenContainerEl !== containerEl) {
            hiddenContainerEl.classList.remove('is-hidden');
            hiddenContainerEl.style.display = '';
          }
          // Скрыть текущую плитку
          containerEl.classList.add('is-hidden');
          containerEl.style.display = 'none';
          hiddenContainerEl = containerEl;
          setTimeout(function() {
            charts.forEach(function(c) { try { c.resize(); } catch(e) {} });
            if (featuredChart) { try { featuredChart.resize(); } catch(e) {} }
          }, 0);
        });
      }
      // Клик по самому графику (canvas внутри)
      if (chart && chart.getZr) {
        chart.getZr().on('click', function() {
          renderFeatured(userChart);
          // Запоминаем выбранного пользователя
          try { sessionStorage.setItem('survFeaturedUserName', userChart.user_name || ''); } catch(e) {}
          // Применяем видимость групп (раскрыть выбранную, остальные скрыть)
          applyGroupVisibility(userChart.user_name || null);
          if (hiddenContainerEl && hiddenContainerEl !== containerEl) {
            hiddenContainerEl.classList.remove('is-hidden');
            hiddenContainerEl.style.display = '';
          }
          containerEl.classList.add('is-hidden');
          containerEl.style.display = 'none';
          hiddenContainerEl = containerEl;
          setTimeout(function() {
            charts.forEach(function(c) { try { c.resize(); } catch(e) {} });
            if (featuredChart) { try { featuredChart.resize(); } catch(e) {} }
          }, 0);
        });
      }
    });

    // Восстановление выбранного графика из sessionStorage после перезагрузки
    (function restoreFeaturedFromStorage() {
      var savedName = null;
      try { savedName = sessionStorage.getItem('survFeaturedUserName'); } catch(e) { savedName = null; }
      if (!savedName) return;
      var userChart = (userDailyStats || []).find(function(u){ return (u && u.user_name) === savedName; });
      if (!userChart) return;
      // Отрисовать вверху
      renderFeatured(userChart);
      // Отразить состояние групп
      applyGroupVisibility(savedName);
      // Найти соответствующую плитку и скрыть её
      var containers = document.querySelectorAll('.surv-approvals-chart-container');
      for (var i=0; i<containers.length; i++) {
        var h3 = containers[i].querySelector('.surv-approvals-user-title');
        var titleText = h3 ? (h3.textContent || h3.innerText || '').trim() : '';
        if (titleText === savedName) {
          containers[i].classList.add('is-hidden');
          containers[i].style.display = 'none';
          hiddenContainerEl = containers[i];
          break;
        }
      }
      setTimeout(function() {
        charts.forEach(function(c) { try { c.resize(); } catch(e) {} });
        if (featuredChart) { try { featuredChart.resize(); } catch(e) {} }
      }, 0);
    })();
  }
  
  // Resize all charts when window is resized
  window.addEventListener('resize', function() {
    charts.forEach(function(chart) {
      chart.resize();
    });
    if (featuredChart) {
      try { featuredChart.resize(); } catch(e) {}
    }
  });
});

</script>
<% end %>