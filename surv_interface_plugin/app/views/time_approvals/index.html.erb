<style>
td.buttons a.icon-edit,
td.buttons a.icon-del {
    display: none !important;
}

</style>
<h2>Согласование трудозатрат</h2>

<% if @query.valid? %>
<% if @entries.empty? %>
<p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
<%= render_query_totals(@query) %>

<div class="surv-approvals-container">
  <div class="surv-approvals-list">
    <%= render :partial => 'timelog/list', :locals => { :entries => @entries }%>
    <span class="pagination"><%= pagination_links_full @entry_pages, @entry_count %></span>
  </div>

  <div class="surv-approvals-charts">
    <!-- Итоги по дням на каждого сотрудника -->
    <% if @user_daily_stats.present? %>
      <div class="surv-approvals-charts-grid">
        <% @user_daily_stats.each_with_index do |user_chart, index| %>
          <div class="surv-approvals-chart-container">
            <h3 class="surv-approvals-user-title"><%= user_chart[:user_name] %></h3>
            <div id="userChart<%= index %>" class="surv-approvals-user-chart"></div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="nodata">Нет данных для отображения графиков</p>
    <% end %>
  </div>

</div>

<% other_formats_links do |f| %>
  <%= f.link_to_with_query_parameters 'CSV', {}, :onclick => "showModal('csv-export-options', '330px'); return false;" %>
  <%= f.link_to_with_query_parameters 'Atom', :key => User.current.atom_key %>
<% end %>

<div id="csv-export-options" class="surv-csv-export-modal">
  <h3 class="surv-csv-export-title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
  <%= form_tag(time_entries_approval_path(:format => 'csv'), :method => :get, :id => 'csv-export-form', :class => 'surv-csv-export-form') do %>
  <%= query_as_hidden_field_tags @query %>
  <%= hidden_field_tag('query_name', @query.name) %>
  <p>
    <label><%= radio_button_tag 'c[]', '', true %> <%= l(:description_selected_columns) %></label><br />
    <label><%= radio_button_tag 'c[]', 'all_inline' %> <%= l(:description_all_columns) %></label>
  </p>
  <% if @query.available_block_columns.any? %>
    <fieldset id="csv-export-block-columns" class="surv-csv-export-fieldset">
      <legend class="surv-csv-export-legend">
        <%= toggle_checkboxes_link('#csv-export-block-columns input[type=checkbox]') %>
      </legend>
      <% @query.available_block_columns.each do |column| %>
        <label><%= check_box_tag 'c[]', column.name, @query.has_column?(:column), :id => nil %> <%= column.caption %></label>
      <% end %>
    </fieldset>
  <% end %>
  <%= export_csv_encoding_select_tag %>
  <%= export_csv_separator_select_tag %>
  <p class="surv-csv-export-buttons">
    <%= submit_tag l(:button_export), :name => nil, :onclick => "hideModal(this);", :data => { :disable_with => false }, :class => 'surv-csv-export-button' %>
    <%= link_to_function l(:button_cancel), "hideModal(this);", :class => 'surv-csv-export-button' %>
  </p>
  <% end %>
</div>
<% end %>
<% end %>

<% content_for :sidebar do %>
  <%= render :partial => 'timelog/sidebar' %>
<% end %>

<% html_title(@query.new_record? ? l(:label_spent_time) : @query.name, l(:label_details)) %>

<% content_for :header_tags do %>
    <%= auto_discovery_link_tag(:atom, {:issue_id => @issue, :format => 'atom', :key => User.current.atom_key}, :title => l(:label_spent_time)) %>
    <script src="/themes/SURV/javascripts/vendor/echarts/echarts.min.js"></script>
    
<% end %>

<% unless @entries.empty? || (@user_daily_stats.nil? || @user_daily_stats.empty?) %>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
  var userDailyStats = <%= raw (@user_daily_stats || []).to_json %>;
  var charts = [];
  
  // Получаем цвет из CSS-класса
  function getColorFromCSS(className) {
    var el = document.createElement('div');
    el.className = className;
    el.style.display = 'none';
    document.body.appendChild(el);
    var color = window.getComputedStyle(el).backgroundColor;
    document.body.removeChild(el);
    return color;
  }
  
  // Convert decimal hours to string like "5ч 10мин"
  function formatHoursMinutes(decimalHours) {
    if (!decimalHours || decimalHours <= 0) return '0мин';
    var hours = Math.floor(decimalHours);
    var minutes = Math.round((decimalHours - hours) * 60);
    if (minutes === 60) { hours += 1; minutes = 0; }
    if (hours > 0 && minutes > 0) {
      return hours + 'ч ' + minutes + 'мин';
    } else if (hours > 0) {
      return hours + 'ч';
    } else {
      return minutes + 'мин';
    }
  }

  // Столбчатые графики по дням для каждого сотрудника
  if (userDailyStats && userDailyStats.length) {
    userDailyStats.forEach(function(userChart, index) {
      var chartDom = document.getElementById('userChart' + index);
      if (!chartDom) { return; }

      var chart = echarts.init(chartDom);
      charts.push(chart);

      var names = userChart.dates;
      var approved = userChart.chart_data.map(function(row) { return row.approved; });
      var unapproved = userChart.chart_data.map(function(row) { return row.unapproved; });
      var deficit = userChart.chart_data.map(function(row) { return row.deficit; });

      var option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function(params) {
            var title = (params[0] && params[0].axisValue) ? params[0].axisValue : '';
            var lines = params.map(function(p) {
              return p.marker + ' ' + p.seriesName + ': ' + formatHoursMinutes(p.value);
            });
            return '<strong>' + title + '</strong><br/>' + lines.join('<br/>');
          }
        },
        legend: { data: ['Согласовано', 'Требуется согласование', 'Нужно занести'] },
        grid: { top: '4%', left: '3%', right: '3%', bottom: '15%', containLabel: true },
        xAxis: { type: 'category', data: names, axisLabel: { interval: 0, rotate: 20 } },
        yAxis: { type: 'value', axisLabel: { formatter: function(v){ return formatHoursMinutes(v); } } },
        series: [
          { name: 'Согласовано', type: 'bar', stack: 'total', data: approved, itemStyle: { color: getColorFromCSS('chart-approved') } },
          { name: 'Требуется согласование', type: 'bar', stack: 'total', data: unapproved, itemStyle: { color: getColorFromCSS('chart-unapproved') } },
          { name: 'Нужно занести', type: 'bar', stack: 'total', data: deficit, itemStyle: { color: getColorFromCSS('chart-deficit') } }
        ]
      };

      chart.setOption(option);
    });
  }
  
  // Resize all charts when window is resized
  window.addEventListener('resize', function() {
    charts.forEach(function(chart) {
      chart.resize();
    });
  });
});

</script>
<% end %>