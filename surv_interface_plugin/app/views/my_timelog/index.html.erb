<h2>Мои трудозатраты</h2>
<%= @query.persisted? && @query.description.present? ? content_tag('p', @query.description, class: 'subtitle') : '' %>

<% if @query.valid? %>

<%# Resolve current spent_on range from params to build week navigation %>
<% current_from, current_to = nil, nil %>
<% if params[:v] && params[:v][:spent_on].is_a?(Array) && params[:v][:spent_on].size >= 2 %>
  <% current_from = Date.parse(params[:v][:spent_on][0]) rescue nil %>
  <% current_to   = Date.parse(params[:v][:spent_on][1]) rescue nil %>
<% end %>
<% week_from = (current_from || Date.today.beginning_of_week(:monday)) %>
<% week_to   = (current_to   || (week_from + 6)) %>
<% prev_from = (week_from - 7).to_s %>
<% prev_to   = (week_to - 7).to_s %>
<% next_from = (week_from + 7).to_s %>
<% next_to   = (week_to + 7).to_s %>

<%# Prepare weekly (Mon..Sun) chart data: Actual vs Deficit to plan. Labels DD.MM.YYYY %>
<% week_start = week_from %>
<% week_dates = (0..6).map { |i| week_start + i } %>
<% # Build approved/unapproved by date from full week scope entries (not only current page) %>
<% approved_by_date = Hash.new(0.0) %>
<% unapproved_by_date = Hash.new(0.0) %>
<% if defined?(@week_entries) && @week_entries.present? %>
  <% # Use fixed custom field id = 2 for approval %>
  <% approved_cf_id = 2 %>
  <% @week_entries.each do |time_entry| %>
    <% d = time_entry.spent_on %>
    <% next unless d >= week_dates.first && d <= week_dates.last %>
    <% hours = time_entry.hours.to_f %>
    <% approved = false %>
    <% if approved_cf_id && time_entry.respond_to?(:custom_values) && time_entry.custom_values.present? %>
      <% cv = time_entry.custom_values.detect { |v| v.custom_field_id == approved_cf_id } %>
      <% if cv %>
        <% val = cv.value %>
        <% approved = (val == true || val == '1' || val.to_s.strip.downcase.in?(['true','t','yes','y','да','1'])) %>
      <% end %>
    <% end %>
    <% if approved %>
      <% approved_by_date[d] += hours %>
    <% else %>
      <% unapproved_by_date[d] += hours %>
    <% end %>
  <% end %>
<% end %>
<% labels = week_dates.map { |d| 
  day_names = ['Вс','Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
  "#{day_names[d.wday]} #{d.strftime('%d.%m')}"
} %>
<% plan = week_dates.map do |d|
     case d.wday
     when 1,2,3,4
       8.67
     when 5
       5.33
     else
       0.0
     end
   end %>
<% approved_raw = week_dates.map { |d| (approved_by_date[d] || 0.0).round(2) } %>
<% unapproved_raw = week_dates.map { |d| (unapproved_by_date[d] || 0.0).round(2) } %>
<% total_raw = approved_raw.each_with_index.map { |v, i| (v + unapproved_raw[i]).round(2) } %>
<% deficit = total_raw.each_with_index.map { |v, i| [plan[i] - v, 0.0].max.round(2) } %>

<div style="display:flex; gap:16px; align-items:flex-start;">
  <div style="flex:1 1 60%; min-width:0;align-items:stretch;">
    <% if User.current.allowed_to?(:log_time, @project, :global => true) %>
      <div style="display:flex; justify-content:flex-end; margin: 4px 0 6px;">
        <%= link_to l(:button_log_time), _new_time_entry_path(@project, @query.filtered_issue_id), :class => 'button-33-red', :style => 'width:auto;' %>
      </div>
    <% end %>
    <div style="margin: 8px 0 6px; display:grid; grid-template-columns: 1fr auto 1fr; gap:8px; align-items:center;">
      <div>
        <%= link_to '← Пред. неделя', my_time_entries_path(:set_filter => '1', :sort => params[:sort] || 'spent_on:desc',
            :f => ['spent_on','author_id',''], :op => {'spent_on' => '><','author_id' => '='},
            :v => {'spent_on' => [prev_from, prev_to], 'author_id' => ['me']}, :group_by => (params[:group_by] || @query.group_by)),
            :class => 'icon icon-previous' %>
      </div>
      <div style="text-align:center; line-height:28px;">
        <strong><%= week_from.strftime('%d.%m.%Y') %> — <%= week_to.strftime('%d.%m.%Y') %></strong>
      </div>
      <div style="display:flex; gap:12px; justify-content:flex-end; align-items:center;">
        <div>Итого за неделю: <strong><%= sprintf('%.2f', @week_total_hours.to_f) %> ч (<%= @week_completion_percent %>%)</strong></div>
        <%= link_to 'След. неделя →', my_time_entries_path(:set_filter => '1', :sort => params[:sort] || 'spent_on:desc',
        :f => ['spent_on','author_id',''], :op => {'spent_on' => '><','author_id' => '='},
        :v => {'spent_on' => [next_from, next_to], 'author_id' => ['me']}, :group_by => (params[:group_by] || @query.group_by)),
        :class => 'icon icon-next' %>
      </div>
    </div>

    <% if @entries.blank? %>
      <p class="nodata"><%= l(:label_no_data) %></p>
    <% else %>
      <%= render :partial => 'timelog/list', :locals => { :entries => @entries }%>
      <span class="pagination"><%= pagination_links_full @entry_pages, @entry_count %></span>

      <div id="csv-export-options" style="display:none;">
        <h3 class="title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
        <%= form_tag(my_time_entries_path(:format => 'csv'), :method => :get, :id => 'csv-export-form') do %>
        <%= query_as_hidden_field_tags @query %>
        <%= hidden_field_tag('query_name', @query.name) %>
        <p>
          <label><%= radio_button_tag 'c[]', '', true %> <%= l(:description_selected_columns) %></label><br />
          <label><%= radio_button_tag 'c[]', 'all_inline' %> <%= l(:description_all_columns) %></label>
        </p>
        <% if @query.available_block_columns.any? %>
          <fieldset id="csv-export-block-columns">
            <legend>
              <%= toggle_checkboxes_link('#csv-export-block-columns input[type=checkbox]') %>
            </legend>
            <% @query.available_block_columns.each do |column| %>
              <label><%= check_box_tag 'c[]', column.name, @query.has_column?(:column), :id => nil %> <%= column.caption %></label>
            <% end %>
          </fieldset>
        <% end %>
        <%= export_csv_encoding_select_tag %>
        <%= export_csv_separator_select_tag %>
        <p class="buttons">
          <%= submit_tag l(:button_export), :name => nil, :onclick => "hideModal(this);", :data => { :disable_with => false } %>
          <%= link_to_function l(:button_cancel), "hideModal(this);" %>
        </p>
        <% end %>
      </div>
    <% end %>
  </div>

  <div style="flex:1 1 40%; min-width:0;">
    <% if approved_raw.any? { |v| v.to_f > 0 } || unapproved_raw.any? { |v| v.to_f > 0 } || deficit.any? { |v| v.to_f > 0 } || plan.any? { |v| v.to_f > 0 } %>
      <div style="text-align:center; font-weight:bold; margin-bottom:6px; font-size:150%;">Распределение по дням недели</div>
      <div id="date-hours-chart" style="height:360px;"></div>
      <script>
        (function() {
          function ready(fn){ if(document.readyState!='loading'){fn()} else {document.addEventListener('DOMContentLoaded', fn)} }
          
          // Функция для конвертации десятичных часов в формат Чч ММмин
          function formatHoursMinutes(decimalHours) {
            if (!decimalHours || decimalHours <= 0) return '0мин';
            var hours = Math.floor(decimalHours);
            var minutes = Math.round((decimalHours - hours) * 60);
            if (minutes === 60) { hours += 1; minutes = 0; }
            if (hours > 0 && minutes > 0) {
              return hours + 'ч ' + minutes + 'мин';
            } else if (hours > 0) {
              return hours + 'ч';
            } else {
              return minutes + 'мин';
            }
          }

          // Функция для получения цвета из CSS классов
          function getColorFromCSS(className) {
            // Создаем временный элемент для получения цвета из CSS
            var tempEl = document.createElement('div');
            tempEl.className = className;
            tempEl.style.display = 'none';
            document.body.appendChild(tempEl);
            
            // Получаем вычисленные стили
            var computedStyle = window.getComputedStyle(tempEl);
            var color = computedStyle.backgroundColor;
            
            // Удаляем временный элемент
            document.body.removeChild(tempEl);
            
            return color || 'rgba(0, 0, 0, 0.7)'; // fallback цвет
          }
          
          ready(function(){
            var el = document.getElementById('date-hours-chart');
            if (!el || typeof echarts === 'undefined') return;
            var labels = <%= raw(labels.to_json) %>;
            var approved_raw = <%= raw(approved_raw.to_json) %>;
            var unapproved_raw = <%= raw(unapproved_raw.to_json) %>;
            var deficit = <%= raw(deficit.to_json) %>;
            
            // Получаем цвета из CSS
            var approvedColor = getColorFromCSS('chart-approved');
            var unapprovedColor = getColorFromCSS('chart-unapproved');
            var deficitColor = getColorFromCSS('chart-deficit');
            
            // Создаем серии с цветами из CSS
            var approved = approved_raw.map(function(v) { 
              return { 
                value: v, 
                itemStyle: { color: approvedColor, borderColor: 'rgba(0,0,0,0.08)', borderWidth: 1 } 
              }; 
            });
            var unapproved = unapproved_raw.map(function(v) { 
              return { 
                value: v, 
                itemStyle: { color: unapprovedColor, borderColor: 'rgba(0,0,0,0.08)', borderWidth: 1 } 
              }; 
            });
            
            var chart = echarts.init(el);
            var option = {
              tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params){
                  var lines = [params[0].axisValue];
                  var appr = 0, unappr = 0, deficitVal = 0;
                  params.forEach(function(p){
                    if(p.seriesName === 'Согласовано'){ appr = (typeof p.data === 'object' ? p.data.value : p.data) || 0; }
                    if(p.seriesName === 'Распределено'){ unappr = (typeof p.data === 'object' ? p.data.value : p.data) || 0; }
                    if(p.seriesName === 'Осталось распределить'){ deficitVal = p.data || 0; }
                  });
                  var total = (appr + unappr);
                  lines.push('Согласовано: ' + formatHoursMinutes(appr));
                  lines.push('Распределено: ' + formatHoursMinutes(unappr));
                  lines.push('Итого факт: ' + formatHoursMinutes(total));
                  if(deficitVal > 0){ lines.push('Осталось распределить: ' + formatHoursMinutes(deficitVal)); }
                  return lines.join('<br/>');
                }
              },
              legend: { data: ['Согласовано', 'Распределено', 'Осталось распределить'] },
              xAxis: { type: 'category', data: labels, axisLabel: { rotate: 0 } },
              yAxis: { type: 'value' },
              grid: { left: 40, right: 20, bottom: 60, top: 50 },
              series: [
                { 
                  name: 'Согласовано', 
                  type: 'bar', 
                  stack: 'plan', 
                  data: approved, 
                  itemStyle: { color: approvedColor, borderColor: 'rgba(0,0,0,0.08)', borderWidth: 1 }, 
                  label: { show: true, position: 'inside', formatter: function(p) { return p.value > 0 ? formatHoursMinutes(p.value) : ''; } } 
                },
                { 
                  name: 'Распределено', 
                  type: 'bar', 
                  stack: 'plan', 
                  data: unapproved, 
                  itemStyle: { color: unapprovedColor, borderColor: 'rgba(0,0,0,0.08)', borderWidth: 1 }, 
                  label: { show: true, position: 'inside', formatter: function(p) { return p.value > 0 ? formatHoursMinutes(p.value) : ''; } } 
                },
                { 
                  name: 'Осталось распределить', 
                  type: 'bar', 
                  stack: 'plan', 
                  data: deficit, 
                  itemStyle: { color: deficitColor, borderColor: 'rgba(0,0,0,0.08)', borderWidth: 1 }, 
                  label: { show: true, position: 'inside', formatter: function(p) { return p.value > 0 ? formatHoursMinutes(p.value) : ''; } } 
                }
              ]
            };
            chart.setOption(option);
            window.addEventListener('resize', function(){ chart.resize(); });
          });
        })();
      </script>
    <% end %>

    <% if @activity_pie_series.present? && @activity_pie_series.any? { |s| s[:value].to_f > 0 } %>
      <div style="display:flex; gap:12px; align-items:stretch;">
        <div style="flex:1 1 50%; min-width:0;">
          <div style="text-align:center; font-weight:bold; margin-bottom:6px; font-size:150%;">Распределение по деятельности</div>
          <div id="activity-pie-chart" style="height:360px;"></div>
          <script>
            (function() {
              function ready(fn){ if(document.readyState!='loading'){fn()} else {document.addEventListener('DOMContentLoaded', fn)} }
              
              // Функция для конвертации десятичных часов в формат Чч ММмин
              function formatHoursMinutes(decimalHours) {
                if (!decimalHours || decimalHours <= 0) return '0мин';
                var hours = Math.floor(decimalHours);
                var minutes = Math.round((decimalHours - hours) * 60);
                if (minutes === 60) { hours += 1; minutes = 0; }
                if (hours > 0 && minutes > 0) {
                  return hours + 'ч ' + minutes + 'мин';
                } else if (hours > 0) {
                  return hours + 'ч';
                } else {
                  return minutes + 'мин';
                }
              }
              
              // Функция для получения цвета активности из CSS
              function getActivityColor(activityId) {
                // Создаем временный элемент для получения цвета из CSS
                var tempEl = document.createElement('div');
                tempEl.className = 'activity-color-' + activityId;
                tempEl.style.display = 'none';
                document.body.appendChild(tempEl);
                
                // Получаем вычисленные стили
                var computedStyle = window.getComputedStyle(tempEl);
                var color = computedStyle.backgroundColor;
                
                // Удаляем временный элемент
                document.body.removeChild(tempEl);
                
                // Если цвет не найден, используем fallback
                if (!color || color === 'rgba(0, 0, 0, 0)' || color === 'transparent') {
                  tempEl.className = 'activity-color-default';
                  document.body.appendChild(tempEl);
                  color = window.getComputedStyle(tempEl).backgroundColor;
                  document.body.removeChild(tempEl);
                }
                
                return color;
              }
              
              ready(function(){
                var el = document.getElementById('activity-pie-chart');
                if (!el || typeof echarts === 'undefined') return;
                var data = <%= raw(@activity_pie_series.to_json) %>;
                
                // Map data with colors from CSS
                var colored = data.map(function(item, idx){
                  var id = item.activity_id;
                  var color = getActivityColor(id);
                  return Object.assign({}, item, { 
                    itemStyle: { color: color }
                  });
                });
                
                var chart = echarts.init(el);
                var option = {
                  tooltip: { 
                    trigger: 'item', 
                    formatter: function(p){ 
                      return (p.name || '') + ': ' + formatHoursMinutes(p.value || 0) + ' (' + (p.percent || 0) + '%)'; 
                    } 
                  },
                  legend: { 
                    show: true,
                    orient: 'vertical',
                    left: 10,
                    top: 20,
                    itemGap: 10,
                    textStyle: {
                      fontSize: 18
                    }
                  },
                  series: [
                    {
                      name: '<%= l(:label_spent_time) %>',
                      type: 'pie',
                      radius: ['30%','70%'],
                      center: ['50%','50%'],
                      avoidLabelOverlap: true,
                      itemStyle: { borderColor: '#fff', borderWidth: 1 },
                      label: {
                        show: true,
                        color: '#ffffff',
                        position: 'inside',
                        formatter: function(p){ 
                          var d = Math.round(p.percent || 0); 
                          return (d > 0 ? d + '%' : ''); 
                        },
                        fontSize: 20,
                        lineHeight: 20,
                        width: 50,
                        overflow: 'break'
                      },
                      emphasis: { scale: true },
                      labelLine: { show: true, length: 16, length2: 10, lineStyle: { width: 3 } },
                      data: colored
                    }
                  ]
                };
                chart.setOption(option);
                window.addEventListener('resize', function(){ chart.resize(); });
              });
            })();
          </script>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% other_formats_links do |f| %>
  <%= f.link_to_with_query_parameters 'CSV', {}, :onclick => "showModal('csv-export-options', '330px'); return false;" %>
  <%= f.link_to_with_query_parameters 'Atom', :key => User.current.atom_key %>
<% end %>

<% content_for :sidebar do %>
  <%= render :partial => 'timelog/sidebar' %>
<% end %>

<% html_title(@query.new_record? ? l(:label_spent_time) : @query.name, l(:label_details)) %>

<% content_for :header_tags do %>
    <%= javascript_include_tag 'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js' %>
    <%= auto_discovery_link_tag(:atom, {:issue_id => @issue, :format => 'atom', :key => User.current.atom_key}, :title => l(:label_spent_time)) %>

    <script>
      // Отключаем контекстное меню (правый клик) на странице Мои трудозатраты
      (function(){
        function ready(fn){ if(document.readyState!='loading'){fn()} else {document.addEventListener('DOMContentLoaded', fn)} }
        ready(function(){
          if (document.body && document.body.classList.contains('controller-my_timelog') && document.body.classList.contains('action-index')) {
            document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, {capture: true});
          }
        });
      })();
    </script>
<% end %>

<% end %>