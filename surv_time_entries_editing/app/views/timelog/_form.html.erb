<%= error_messages_for 'time_entry' %>
<%= back_url_hidden_field_tag %>

<div class="mte-day-stats-wrapper" style="margin-bottom: 10px;">
  <div class="mte-stats-box" style="padding: 6px 0;">
    <div class="mte-stats-title">Трудозатраты на</div>
    <div id="mte-echarts" style="width: 100%; min-height: 120px;"></div>
  </div>
  
  <%= javascript_tag do %>
    (function(){
      // Функция для преобразования часов в формат "Xч Yмин"
      function formatHoursToHM(hours) {
        var totalMinutes = Math.round(hours * 60);
        var h = Math.floor(totalMinutes / 60);
        var m = totalMinutes % 60;
        if (h === 0) return m + 'мин';
        if (m === 0) return h + 'ч';
        return h + 'ч ' + m + 'мин';
      }

      // Функция для форматирования десятичных часов (8.67 -> "8.67")
      function formatDecimalHours(hours) {
        return Number(hours).toFixed(2);
      }

      // Функция для получения цвета активности из CSS
      function getActivityColor(activityId) {
        // Создаем временный элемент для получения цвета из CSS
        var tempEl = document.createElement('div');
        tempEl.className = 'activity-color-' + activityId;
        tempEl.style.display = 'none';
        document.body.appendChild(tempEl);
        
        // Получаем вычисленные стили
        var computedStyle = window.getComputedStyle(tempEl);
        var color = computedStyle.backgroundColor;
        
        // Удаляем временный элемент
        document.body.removeChild(tempEl);
        
        // Если цвет не найден, используем fallback
        if (!color || color === 'rgba(0, 0, 0, 0)' || color === 'transparent') {
          tempEl.className = 'activity-color-default';
          document.body.appendChild(tempEl);
          color = window.getComputedStyle(tempEl).backgroundColor;
          document.body.removeChild(tempEl);
        }
        
        return color;
      }

      // Упрощенный расчет плана по дню недели из строки YYYY-MM-DD (локально)
      function getPlanHours(dateString) {
        var date;
        if (dateString && typeof dateString === 'string') {
          var m = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (m) {
            date = new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
          }
        }
        if (!date) { return 0.0; }
        var w = date.getDay(); // 0..6 (Вс..Сб)
        if (w === 1 || w === 2 || w === 3 || w === 4) return 8.67; // Пн-Чт
        if (w === 5) return 5.33; // Пт
        return 0.0; // Сб-Вс
      }

      // Нормализуем входящую дату к формату YYYY-MM-DD. Поддержка 'YYYY-MM-DD' и 'DD.MM.YYYY'.
      function normalizeDateString(input) {
        if (!input || typeof input !== 'string') return null;
        var iso = input.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (iso) return input;
        var ru = input.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
        if (ru) {
          return ru[3] + '-' + ru[2] + '-' + ru[1];
        }
        return null;
      }

      // Загрузка ECharts один раз
      var echartsLoaded = false;
      function loadEcharts() {
        return new Promise(function(resolve, reject){
          if (window.echarts) { echartsLoaded = true; return resolve(window.echarts); }
          if (echartsLoaded) { return resolve(window.echarts); }
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js';
          s.async = true;
          s.onload = function(){ echartsLoaded = true; resolve(window.echarts); };
          s.onerror = function(){ reject(new Error('Failed to load ECharts')); };
          document.head.appendChild(s);
        });
      }

      function renderChart(data) {
        var el = document.getElementById('mte-echarts');
        if (!el || !window.echarts) return;
        var chart = window.echarts.getInstanceByDom(el) || window.echarts.init(el);
        var entries = Array.isArray(data && data.entries) ? data.entries : [];
        
        // Сортируем по активности и времени создания для стабильного порядка
        entries = entries.slice().sort(function(a, b){
          var aid = (a.activity_id || 0) - (b.activity_id || 0);
          if (aid !== 0) return aid;
          var at = a.created_on || '';
          var bt = b.created_on || '';
          return at.localeCompare(bt);
        });

        // Рассчитываем общее количество распределенных часов
        var totalLoggedHours = entries.reduce(function(sum, entry) {
          return sum + (Number(entry.hours) || 0);
        }, 0);

        // Получаем плановые часы для текущей даты
        var planHours = getPlanHours(data && data.date);
        
        // Рассчитываем оставшиеся часы для распределения
        var remainingHours = Math.max(0, planHours - totalLoggedHours);

        // Формируем серии для распределенных часов
        var dataSeries = entries.map(function(e, idx){
          var actId = e.activity_id;
          var color = getActivityColor(actId);
          var val = Number((Number(e.hours) || 0).toFixed(2));
          var labelVisible = val > 0.0;
          return {
            name: (e.activity_name || 'Без активности'),
            type: 'bar',
            stack: 'total',
            data: [val],
            label: { 
              show: labelVisible, 
              position: 'inside', 
              formatter: function(p){ 
                return (p && typeof p.value === 'number' && p.value > 0) ? formatHoursToHM(p.value) : ''; 
              }, 
              color: '#ffffff', // Белый цвет текста
              fontSize: 11,
              fontWeight: 'bold'
            },
            itemStyle: { 
              color: color, 
              borderColor: 'rgba(0,0,0,0.08)', 
              borderWidth: 1 
            },
            emphasis: { focus: 'series' },
            _meta: { 
              comments: e.comments || '', 
              issue: e.issue_subject || '', 
              time: e.created_on || '',
              hours: val
            }
          };
        });

        // Фоновая серия плана (теневой бар), чтобы график не был пустым и план всегда был виден
        var planShadowSeries = {
          name: 'План',
          type: 'bar',
          data: [planHours > 0 ? planHours : 0],
          barGap: '-100%', // накладываем на остальные бары
          itemStyle: {
            color: 'rgba(0,0,0,0.08)'
          },
          silent: true, // не влияет на ховер
          z: 0,
          zlevel: 0
        };

        // Добавляем серию для оставшихся часов (красным цветом)
        if (remainingHours > 0) {
          dataSeries.push({
            name: 'Осталось распределить',
            type: 'bar',
            stack: 'total',
            data: [remainingHours],
            label: {
              show: true,
              position: 'inside',
              formatter: function(p) {
                return (p && typeof p.value === 'number' && p.value > 0) ? formatHoursToHM(p.value) : '';
              },
              color: '#ffffff', // Белый текст на красном фоне
              fontSize: 11,
              fontWeight: 'bold'
            },
            itemStyle: {
              color: 'rgba(229, 57, 53, 0.7)', // Красный цвет
              borderColor: 'rgba(0,0,0,0.08)',
              borderWidth: 1
            },
            emphasis: { focus: 'series' },
            _meta: {
              comments: 'Не распределенное время',
              hours: remainingHours
            }
          });
        }

        // Итоговый список серий: сначала тень плана, затем реальные данные
        var series = [planShadowSeries].concat(dataSeries);

        var option = {
            // Общий стиль текста для всей диаграммы
          textStyle: {
            fontFamily: 'Segoe UI, Segoe, Tahoma, Arial, sans-serif'
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            position: function(pos, params, dom, rect, size) {
              // Place tooltip at the bottom of the chart view
              var x = pos[0];
              var viewHeight = size.viewSize[1];
              var boxHeight = size.contentSize[1];
              var bottomY = viewHeight - boxHeight - 6; // small padding from bottom
              return [x, bottomY];
            },
            confine: true,
            formatter: function(params){
              if (!params || !params.length) return '';
              
              var dateLine = (data && data.date) ? (data.date + '<br/>') : '';
              var parts = [dateLine];
              
              // Добавляем информацию о плане и остатке
              if (planHours > 0) {
                parts.push('<strong>План:</strong> ' + formatHoursToHM(planHours));
                parts.push('<strong>Распределено:</strong> ' + formatHoursToHM(totalLoggedHours));
                if (remainingHours > 0) {
                  parts.push('<strong style=\"color: #e53935;\">Осталось распределить:</strong> ' + formatHoursToHM(remainingHours));
                }
                parts.push(''); // Пустая строка для разделения
              }
              
              // Группируем по активности (на случай нескольких записей с одной активностью)
              var activityMap = {};
              
              params.forEach(function(p){
                var activityName = p.seriesName || 'Без активности';
                var hours = p.value || 0;
                var comment = '';
                
                // Получаем комментарий из метаданных
                try {
                  var s = (p && p.seriesIndex != null && chart && chart.getOption().series[p.seriesIndex]);
                  comment = s && s._meta && s._meta.comments ? String(s._meta.comments) : '';
                } catch(e) {}
                
                if (!activityMap[activityName]) {
                  activityMap[activityName] = {
                    totalHours: 0,
                    comments: []
                  };
                }
                
                activityMap[activityName].totalHours += hours;
                if (comment && !activityMap[activityName].comments.includes(comment)) {
                  activityMap[activityName].comments.push(comment);
                }
              });
              
              // Формируем строки для тултипа - каждая активность с новой строки
              Object.keys(activityMap).forEach(function(activityName) {
                var info = activityMap[activityName];
                var hoursFormatted = formatHoursToHM(info.totalHours);
                var hoursDecimal = formatDecimalHours(info.totalHours);
                var line = '<strong>' + activityName + ':</strong> ' + hoursFormatted;
                
                // Добавляем комментарии если есть
                if (info.comments.length > 0) {
                  line += '<br/>- ' + info.comments.join('<br/>- ');
                }
                
                parts.push(line);
              });
              
              return parts.join('<br/>');
            }
          },
          legend: { show: false },
          grid: { 
            left: '0%', 
            right: '0%', 
            top: '0%', 
            bottom: '0%', 
            containLabel: true 
          },
          xAxis: { 
            type: 'value', 
            axisLabel: { 
              formatter: function(value) {
                return formatHoursToHM(value);
              }, 
              fontSize: 11,
              color: '#FFFFFF' 
            }, 
            min: 0,
            // Устанавливаем максимум как максимум из плана и распределенных часов,
            // чтобы график был информативным даже при отсутствии плана в данных
            max: (function(){
              var maxByData = totalLoggedHours;
              var maxByPlan = planHours > 0 ? planHours : 0;
              var m = Math.max(maxByData, maxByPlan);
              return m > 0 ? m : null; // null позволит ECharts автоподобрать
            })()
          },
          yAxis: { 
            type: 'category', 
            data: [''], 
            axisLabel: { show: false }, 
            axisTick: { show: false } 
          },
          series: series
        };
        chart.setOption(option, true);
        
        // Заголовок с датой
        var titleEl = el.parentNode && el.parentNode.querySelector('.mte-stats-title');
        if (titleEl) { 
          var titleText = 'Трудозатраты на';
          if (data && data.date) {
            titleText += ' — ' + data.date;
          }
          if (planHours > 0) {
            titleText += ' (План: ' + formatHoursToHM(planHours) + ')';
          }
          titleEl.textContent = titleText; 
        }
      }

      function fetchAndRender(date, userId, projectId) {
        var params = new URLSearchParams({ date: date || '', user_id: userId || '', project_id: projectId || '' });
        var urlPrimary = '/timelog/for_date?' + params.toString();
        var urlFallback = '/time_entries/for_date?' + params.toString();
        var requestedDate = normalizeDateString(date);
        if (!requestedDate) {
          var now = new Date();
          var y = now.getFullYear();
          var m = (now.getMonth() + 1).toString().padStart(2,'0');
          var dd = now.getDate().toString().padStart(2,'0');
          requestedDate = y + '-' + m + '-' + dd;
        }
        return fetch(urlPrimary, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }})
          .then(function(r){ if (r.ok) return r.json(); if (r.status === 404) return fetch(urlFallback, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }}); throw new Error('HTTP ' + r.status); })
          .then(function(resOrData){ return resOrData && (typeof resOrData.json === 'function' ? resOrData.json() : resOrData); })
          .then(function(data){
            var respEntries = (data && Array.isArray(data.entries)) ? data.entries : [];
            var respDate = (data && typeof data.date === 'string') ? normalizeDateString(data.date) : null;
            var finalDate = respDate || requestedDate;
            renderChart({ entries: respEntries, date: finalDate });
          })
          .catch(function(){
            renderChart({ entries: [], date: requestedDate });
          });
      }

      // Переопределяем глобальную функцию, чтобы отключить alert из assets JS
      window.getTimeEntriesForDate = function(date, userId, projectId){
        loadEcharts().then(function(){ fetchAndRender(date, userId, projectId); });
      };

      function currentForm() {
        return document.getElementById('new_time_entry') || document.querySelector('.edit_time_entry') || (document.getElementById('time_entry_hours') && document.getElementById('time_entry_hours').closest('form'));
      }

      function init() {
        var form = currentForm();
        var dateField = form && form.querySelector('#time_entry_spent_on');
        var userIdField = form && form.querySelector('#time_entry_user_id');
        var projectIdField = form && form.querySelector('#time_entry_project_id');
        loadEcharts().then(function(){
          var dateVal = dateField && dateField.value;
          var userVal = userIdField && userIdField.value;
          var projectVal = projectIdField && projectIdField.value;
          if (dateVal) { fetchAndRender(dateVal, userVal, projectVal); } else { renderChart({ entries: [], date: '' }); }
          if (dateField) {
            // Перехватываем событие change в capture-фазе, чтобы заблокировать обработчик из assets JS (с алертом)
            dateField.addEventListener('change', function(e){
              try { e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault(); } catch(_) {}
              fetchAndRender(this.value, (userIdField && userIdField.value), (projectIdField && projectIdField.value));
            }, true);
          }
        });
      }

      if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } else { init(); }
    })();
  <% end %>
</div>

<div class="box tabular">
  <% if @time_entry.new_record? && params[:project_id] %>
    <%= hidden_field_tag 'project_id', params[:project_id] %>
  <% elsif @time_entry.new_record? && params[:issue_id] %>
    <%= hidden_field_tag 'issue_id', params[:issue_id] %>
  <% else %>
    <p><%= f.select :project_id, project_tree_options_for_select(Project.allowed_to(:log_time).to_a, :selected => @time_entry.project, :include_blank => true), :required => true %></p>
  <% end %>

  <p>
    <%= f.text_field :issue_id, :size => 6, :required => Setting.timelog_required_fields.include?('issue_id') %>
    <span id="time_entry_issue">
      <%=  link_to_issue(@time_entry.issue) if @time_entry.issue.try(:visible?) %>
    </span>
  </p>

  <% if User.current.allowed_to?(:log_time_for_other_users, @project) %>
    <p><%= f.select :user_id, user_collection_for_select_options(@time_entry), :required => true %></p>
  <% elsif !@time_entry.new_record? %>
    <p>
      <%= f.label_for_field :user_id %>
      <span><%= link_to_user(@time_entry.user) %></span>
    </p>
  <% end %>
  <p><%= f.date_field :spent_on, :size => 10, :required => true %><%= calendar_for('time_entry_spent_on') %></p>
  <p><%= f.hours_field :hours, :size => 6, :required => true %></p>
  <p><%= f.text_field :comments, :size => 100, :maxlength => 1024, :required => Setting.timelog_required_fields.include?('comments') %></p>
  <p><%= f.select :activity_id, activity_collection_for_select_options(@time_entry), :required => true %></p>
  <% @time_entry.editable_custom_field_values.each do |value| %>
    <p><%= custom_field_tag_with_label :time_entry, value %></p>
    <% if value.custom_field.full_text_formatting? %>
      <%= wikitoolbar_for "time_entry_custom_field_values_#{value.custom_field_id}", preview_issue_path(:project_id => @project) %>
    <% end %>
  <% end %>
  <%= call_hook(:view_timelog_edit_form_bottom, { :time_entry => @time_entry, :form => f }) %>
</div>

<%= javascript_tag do %>
  $(document).ready(function(){
    $('#time_entry_project_id').change(function(){
      $('#time_entry_issue_id').val('');
    });
    $('#time_entry_project_id, #time_entry_issue_id').change(function(){
      $.ajax({
        url: '<%= escape_javascript(@time_entry.new_record? ? new_time_entry_path(:format => 'js') : edit_time_entry_path(:format => 'js')) %>',
        type: 'post',
        data: $(this).closest('form').serialize()
      });
    });
  });

  observeAutocompleteField('time_entry_issue_id',
    function(request, callback) {
      var url = '<%= j auto_complete_issues_path %>';
      var data = {
        term: request.term
      };
      var project_id;
      <% if @time_entry.new_record? && @project %>
      project_id = '<%= @project.id %>';
      <% else %>
      project_id = $('#time_entry_project_id').val();
      <% end %>
      if(project_id){
        data['project_id'] = project_id;
      } else {
        data['scope'] = 'all';
      }

      $.get(url, data, null, 'json')
        .done(function(data){
          callback(data);
        })
        .fail(function(jqXHR, status, error){
          callback([]);
        });
    },
    {
      select: function(event, ui) {
        $('#time_entry_issue').text('');
        $('#time_entry_issue_id').val(ui.item.value).change();
      }
    }
  );
<% end %>

<% content_for :header_tags do %>
  
<% end %>